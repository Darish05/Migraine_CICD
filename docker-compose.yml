services:
  # MLflow Tracking Server
  mlflow:
    image: ghcr.io/mlflow/mlflow:latest
    container_name: mlflow-server
    ports:
      - "5000:5000"
    volumes:
      - mlruns:/mlflow/mlruns
      - models:/mlflow/models
    command: mlflow server --host 0.0.0.0 --port 5000 --backend-store-uri sqlite:///mlflow/mlruns/mlflow.db --default-artifact-root /mlflow/mlruns
    networks:
      - migraine-network
    restart: unless-stopped

  # Migraine Prediction API
  api:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: migraine-api
    ports:
      - "8000:8000"
    volumes:
      - models:/app/models
      - ./data:/app/data
      - mlruns:/app/mlruns
    environment:
      - MLFLOW_TRACKING_URI=http://mlflow:5000
      - PYTHONUNBUFFERED=1
    depends_on:
      - mlflow
    networks:
      - migraine-network
    restart: unless-stopped
    command: uvicorn app:app --host 0.0.0.0 --port 8000 --reload

  # Streamlit UI
  streamlit:
    build:
      context: .
      dockerfile: Dockerfile.streamlit
    container_name: migraine-streamlit
    ports:
      - "8501:8501"
    environment:
      - PYTHONUNBUFFERED=1
    depends_on:
      - api
    networks:
      - migraine-network
    restart: unless-stopped

  # PostgreSQL Database (optional - for production)
  # postgres:
  #   image: postgres:15-alpine
  #   container_name: migraine-db
  #   environment:
  #     - POSTGRES_DB=migraine_db
  #     - POSTGRES_USER=admin
  #     - POSTGRES_PASSWORD=admin123
  #   ports:
  #     - "5432:5432"
  #   volumes:
  #     - postgres-data:/var/lib/postgresql/data
  #   networks:
  #     - migraine-network
  #   restart: unless-stopped

  # Prometheus (optional - for monitoring)
  # prometheus:
  #   image: prom/prometheus:latest
  #   container_name: prometheus
  #   ports:
  #     - "9090:9090"
  #   volumes:
  #     - ./prometheus.yml:/etc/prometheus/prometheus.yml
  #     - prometheus-data:/prometheus
  #   command:
  #     - '--config.file=/etc/prometheus/prometheus.yml'
  #     - '--storage.tsdb.path=/prometheus'
  #   networks:
  #     - migraine-network
  #   restart: unless-stopped

  # Grafana (optional - for visualization)
  # grafana:
  #   image: grafana/grafana:latest
  #   container_name: grafana
  #   ports:
  #     - "3000:3000"
  #   environment:
  #     - GF_SECURITY_ADMIN_PASSWORD=admin
  #   volumes:
  #     - grafana-data:/var/lib/grafana
  #   depends_on:
  #     - prometheus
  #   networks:
  #     - migraine-network
  #   restart: unless-stopped

networks:
  migraine-network:
    driver: bridge

volumes:
  postgres-data:
  prometheus-data:
  grafana-data:
  mlruns:
  models:
